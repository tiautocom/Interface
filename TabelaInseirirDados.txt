TABELA PARA TRANSFERIRI INFORMACOES


CLIENTE_TELEFONE
CLIENTE_ENDERECO
CLIENTE
DEPARTAMENTO
PAGAMENTO_VENDA
PARAMETRO
PRODUTO
USUARIO
VENDA
















////////////////////////////////////////////////
USE [CFe]
GO

/****** Object:  Table [dbo].[CONTAS_A_RECEBER]    Script Date: 29/06/2020 15:48:34 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[CONTAS_A_RECEBER](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[ID_PAGTO_VENDA] [int] NOT NULL,
	[VALOR_A_RECEBER] [decimal](10, 3) NOT NULL,
	[VALOR_RECEBIDO] [decimal](10, 3) NULL,
	[DT_VECTO] [date] NOT NULL,
	[DT_RECEBIMENTTO] [datetime] NULL,
	[ID_USUARIO] [int] NOT NULL,
	[MULTA] [decimal](10, 3) NULL,
	[JUROS] [decimal](10, 3) NULL,
	[BAIXADO] [bit] NOT NULL,
 CONSTRAINT [PK_CONTAS_A_RECEBER] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
	    

GO

ALTER TABLE [dbo].[USUARIO]

	add  [PERMISSAO] [bit] NULL,
	     [LOGADO] [bit] NULL;



ALTER TABLE [dbo].[USUARIO]

	add  [TIME_TELA_DESC][INT] NULL;


ALTER TABLE [dbo].[VENDA]

	add  [TAG] [bit] NULL;



	UPDATE USUARIO set TIPO_USUARIO = 1 , PERMISSAO= 1,  LOGADO= 0, ATIVADO = 1

	UPDATE PARAMETRO SET [TIME_TELA_DESC] = 10

	UPDATE VENDA set TAG = 1 

Alter Venda Qtde decimal(18, 4)

Criar Pasta CUPOM/RESP
 e Mapear

//PROCEDURES

CREATE PROCEDURE [dbo].[uspNumVendaPesquisarCaixa]
	@NUM_CAIXA INT
AS 
BEGIN 
	SELECT NUM_VENDA FROM NUM_CAIXA WHERE NUM_CAIXA=@NUM_CAIXA 
END;

CREATE PROCEDURE [dbo].[uspUsuarioPesquisarLoginOperante]
	@NUM_CAIXA INT,
	@ATIVADO BIT,
	@LOGADO BIT
AS 
BEGIN 
	SELECT * FROM USUARIO WHERE NUM_CAIXA=@NUM_CAIXA AND ATIVADO=@ATIVADO AND LOGADO=@LOGADO;
END

GO
GO

CREATE PROCEDURE [dbo].[uspVendaListarNumAgrup]
	@NUM_CAIXA INT,
	@NUM_VENDA INT
AS 
BEGIN 
	SELECT ROW_NUMBER() OVER(ORDER BY DESCRICAO_PRODUTO ASC) AS ITEM, P.COD_INT AS ID_PROD, V.UNID, V.DESCRICAO_PRODUTO, V.COD_BARRA, SUM(V.QUANT) AS QUANT, V.PRECO, SUM(V.TOTAL) AS TOTAL, 
	P.COD_INT, P.ESTOQUE, P.NCM, P.CFOP, P.ORIGEM_PRODUTO, P.CST_PIS, P.TRIB AS ALIQUOTA, P.ICMS_CST
	FROM VENDA V LEFT JOIN PRODUTO P ON V.ID_PROD = P.COD_INT
	WHERE V.NUM_CAIXA=@NUM_CAIXA AND V.NUM_VENDA=@NUM_VENDA
	GROUP BY V.DESCRICAO_PRODUTO, V.COD_BARRA, V.PRECO, P.COD_INT, V.UNID, P.ESTOQUE, P.NCM, P.CFOP, P.CST_PIS, P.TRIB, P.ORIGEM_PRODUTO, P.ICMS_CST, P.COD_INT 
	ORDER BY ITEM ASC
END

CREATE PROCEDURE [dbo].[uspVendaPesquisarTotal]
	@NUM_CAIXA INT,
	@ID_USUARIO INT
AS 

BEGIN

SELECT VENDA.COD_BARRA as COD, DESCRICAO_PRODUTO AS DESCRICAO, VENDA.UNID AS UNID, VENDA.PRECO AS PRECO, SUM (QUANT)AS QTDE, SUM (TOTAL) AS TOTAL
FROM VENDA JOIN PRODUTO ON PRODUTO.COD_INT = VENDA.ID_PROD 
WHERE VENDA.ID_USUARIO=@ID_USUARIO
AND VENDA.BAIXADO =0 AND VENDA.NUM_CAIXA=@NUM_CAIXA
GROUP BY VENDA.COD_BARRA,DESCRICAO_PRODUTO, SETOR, VENDA.UNID, VENDA.PRECO
ORDER BY DESCRICAO_PRODUTO asc

END;

CREATE PROCEDURE [dbo].[uspPagamentoVendaListar]
	@BAIXADO BIT,
	@NUM_CAIXA INT
AS 
BEGIN 
SELECT TP.TIPO_PAGTO_ID, TP.TIPO_PAGTO, SUM(PV.VALOR - PV.TROCO) AS VALOR FROM TIPO_PAGTO TP 
JOIN PAGAMENTO_VENDA PV ON TP.TIPO_PAGTO_ID=PV.TIPO_PAGAMENTO WHERE PV.NUM_CAIXA=@NUM_CAIXA 
AND PV.BAIXADO=@BAIXADO GROUP BY TP.TIPO_PAGTO_ID, TP.TIPO_PAGTO ORDER BY TP.TIPO_PAGTO_ID ASC
END


CREATE PROCEDURE [dbo].[uspSangriaPesquisarSangria]
	@ID_USUARIO INT,
	@NUM_CAIXA INT
AS 
BEGIN 
	SELECT S.ID_USUARIO, S.TIPO AS TIPO, S.VALOR FROM SANGRIA S WHERE S.NUM_CAIXA=@NUM_CAIXA AND S.ID_USUARIO=@ID_USUARIO AND S.FECHADO=0 GROUP BY S.ID_USUARIO, S.TIPO, S.VALOR;
END


ALTER PROCEDURE [dbo].[uspUsuarioPesquisarId]
	@ID_USUARIO int
AS 
BEGIN 
	SELECT * FROM USUARIO WHERE ID_USUARIO=@ID_USUARIO;
END;

CREATE PROCEDURE [dbo].[uspUsuarioPesqusiarlogin]
	@SENHA NCHAR(10),
	@NUM_CAIXA INT
AS 
BEGIN 
	SELECT * FROM USUARIO U WHERE U.NUM_CAIXA=@NUM_CAIXA AND U.SENHA=@SENHA;
END

ALTER PROCEDURE [dbo].[uspCancelarItens]
	@ID INT
AS 
BEGIN 

	DELETE FROM VENDA WHERE ID_PROD=@ID;

	SELECT @ID AS RETORNO;
END

CREATE PROCEDURE [dbo].[uspCsosnPesquisar]
	@CST VARCHAR(10)

AS 
BEGIN 
	SELECT * FROM CSOSN C WHERE C.CST=@CST;
END;
GO



CREATE PROCEDURE [dbo].[uspVendas]
	@NUM_CAIXA INT,
	@NUM_VENDA INT
AS 
BEGIN 
	SELECT * FROM VENDA WHERE NUM_CAIXA=@NUM_CAIXA AND NUM_VENDA=@NUM_VENDA;
END

GO


CREATE PROCEDURE [dbo].[uspUsuarioAlterarStatusFechado]
	@NUM_CAIXA INT,
	@ID_USUARIO INT,
	@STATUS BIT
AS 

BEGIN

	UPDATE USUARIO SET PERMISSAO=@STATUS WHERE ID_USUARIO=@ID_USUARIO AND NUM_CAIXA=@NUM_CAIXA;

	SELECT @ID_USUARIO AS RETORNO;

END;

CREATE PROCEDURE [dbo].[uspSangriaFechar]
    @ID_USUARIO INT,
	@NUM_CAIXA INT,
	@FECHADO BIT
AS 

BEGIN

	UPDATE SANGRIA SET FECHADO=@FECHADO WHERE NUM_CAIXA=@NUM_CAIXA AND ID_USUARIO=@ID_USUARIO;

	SELECT @NUM_CAIXA AS RETORNO;

END;

CREATE PROCEDURE [dbo].[uspUsuarioAbrirLogin]
	@ID_USUARIO INT,
	@STATUS BIT
AS 
BEGIN 
	UPDATE USUARIO SET LOGADO=@STATUS WHERE ID_USUARIO=@ID_USUARIO;

	SELECT @ID_USUARIO AS RETORNO;
END

ALTER PROCEDURE [dbo].[uspPagamentoVendaPesquisar]
	@NUM_VENDA INT,
	@NUM_CAIXA INT
AS 
BEGIN 
	SELECT * FROM PAGAMENTO_VENDA V JOIN TIPO_PAGTO TP ON V.TIPO_PAGAMENTO=TP.TIPO_PAGTO_ID WHERE V.NUM_CAIXA=@NUM_CAIXA AND V.NUM_CUPOM=@NUM_VENDA;
END;

CREATE PROCEDURE uspVendaPesquisarCaixaItem
	@NUM_CAIXA INT,
	@NUM_VENDA INT
AS 
BEGIN
	SELECT * FROM VENDA V WHERE V.NUM_CAIXA=@NUM_CAIXA AND V.NUM_VENDA=@NUM_VENDA
END;

CREATE PROCEDURE uspVendaTemp
	@ITEM INT,
	@ID_PRODUTO INT
AS 
BEGIN
	INSERT INTO VENDA_TEMP(ITEM, ID_PRODUTO)VALUES(@ITEM, @ID_PRODUTO);

	SELECT @@IDENTITY AS RETORNO;
END;


ALTER PROCEDURE [dbo].[uspNumVendaPesquisarCaixa]
	@NUM_CAIXA INT
AS 
BEGIN 
	SELECT NUM_VENDA FROM NUM_CAIXA WHERE NUM_CAIXA=@NUM_CAIXA 

		DELETE FROM VENDA_TEMP
END;


USE [CFe]
GO

/****** Object:  StoredProcedure [dbo].[uspVendaItem]    Script Date: 28/08/2020 17:14:31 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [dbo].[uspVendaItem]
 @COD_BARRA VARCHAR(20),
 @DESCRICAO_PRODUTO VARCHAR(50),
 @QUANT DECIMAL(10,5),
 @TOTAL DECIMAL(12,2),
 @ITEM INT,
 @DATA DATETIME,
 @ID_PROD INT,
 @ID_USUARIO INT,
 @CUSTO DECIMAL(12,2),
 @BAIXADO BIT,
 @NUM_VENDA INT,
 @ALIQUOTA NCHAR(20),
 @PRECO DECIMAL(10,3),
 @VALOR_PIS NCHAR(10),
 @CST_PIS NCHAR(20),
 @VALOR_COFINS NCHAR(20),
 @CST_COFINS NCHAR(20),
 @CFOP NCHAR(20),
 @NCM NCHAR(20),
 @ORIGEM_PRODUTO NCHAR(20),
 @ICM_CST NCHAR(20),
 @FECH NCHAR(20),
 @CEST NCHAR(20),
 @NUM_CAIXA INT,
 @ANP NCHAR(20),
 @UNID NCHAR(20),
 @TAG BIT
AS
BEGIN 
 INSERT INTO VENDA (COD_BARRA, DESCRICAO_PRODUTO, QUANT, TOTAL, ITEM, DATA, ID_PROD, ID_USUARIO, CUSTO, BAIXADO, NUM_VENDA, ALIQUOTA, PRECO, VALOR_PIS, VALOR_COFINS, CST_COFINS, CFOP,NCM, ORIGEM_PRODUTO, ICM_CST, FECH, CEST, NUM_CAIXA, ANP, UNID, TAG)
 VALUES(@COD_BARRA, @DESCRICAO_PRODUTO, @QUANT, @TOTAL, @ITEM, @DATA, @ID_PROD, @ID_USUARIO, @CUSTO, @BAIXADO, @NUM_VENDA, @ALIQUOTA, @PRECO, @VALOR_PIS, @VALOR_COFINS, @CST_COFINS, @CFOP, @NCM, @ORIGEM_PRODUTO, @ICM_CST, @FECH, @CEST, @NUM_CAIXA, @ANP, @UNID, @TAG)
 SELECT @@IDENTITY AS RETORNO

 	DELETE FROM VENDA_TEMP
END


GO


ALTER PROCEDURE [dbo].[uspVendaTemp]
	@ITEM INT,
	@ID_PRODUTO INT,
	@QUANTIDADE VARCHAR(25)
AS 
BEGIN
	INSERT INTO VENDA_TEMP(ITEM, ID_PRODUTO, QUANTIDADE)VALUES(@ITEM, @ID_PRODUTO, @QUANTIDADE);

	SELECT @ID_PRODUTO AS RETORNO;
END;

CREATE PROCEDURE uspVendaFormatarItemVendas
	@ITEM INT,
	@ID INT
AS 
BEGIN 
	UPDATE VENDA SET ITEM=@ITEM WHERE ID=@ID

	SELECT @ID AS RETORNO;
END;


CREATE PROCEDURE [dbo].[uspParametroAlterarCupom]
	@BANDEIRA BIT,
	@NUM_CAIXA INT
AS 
BEGIN 
	UPDATE NUM_CAIXA SET BANDEIRA=@BANDEIRA WHERE NUM_CAIXA=@NUM_CAIXA;

	SELECT @NUM_CAIXA AS RETORNO;
END

GO

ALTER PROCEDURE [dbo].[uspVendaPesquisarDepartamento]
	@NUM_CAIXA INT
AS 
BEGIN 
	SELECT NUM_DEPAR AS DEP, DEPARTAM AS DEPARTAMENTO, SUM(total) AS TOTAL FROM VENDA  
	 INNER JOIN PRODUTO ON PRODUTO.COD_INT = VENDA.ID_PROD WHERE VENDA.BAIXADO = 0 
	 AND VENDA.NUM_CAIXA=@NUM_CAIXA
	 GROUP BY NUM_DEPAR, DEPARTAM 
	 ORDER BY PRODUTO.NUM_DEPAR ASC;
END;

ALTER PROCEDURE [dbo].[uspVendaPesquisarCancelada]
	@NUM_CAIXA INT
AS 
BEGIN 
SELECT VENDA.COD_BARRA AS COD, DESCRICAO_PRODUTO AS DESCRICAO, VENDA.UNID, VENDA.PRECO, SUM (QUANT)AS QTDE, SUM (TOTAL) AS TOTAL, ESTOQUE FROM VENDA 
LEFT JOIN PRODUTO P ON VENDA.ID_PROD = P.COD_INT
WHERE VENDA.BAIXADO = 0  AND VENDA.QUANT < 0 AND VENDA.NUM_CAIXA=@NUM_CAIXA
GROUP BY VENDA.COD_BARRA,DESCRICAO_PRODUTO,VENDA.UNID, VENDA.PRECO, ESTOQUE ORDER BY DESCRICAO_PRODUTO asc
END;


CREATE PROCEDURE [dbo].[uspVendaPesquisarTotalEstoque]
	@NUM_CAIXA INT,
	@ID_USUARIO INT
AS 

BEGIN

SELECT VENDA.COD_BARRA as COD, DESCRICAO_PRODUTO AS DESCRICAO, VENDA.UNID AS UNID, VENDA.PRECO AS PRECO, SUM (QUANT)AS QTDE, SUM (TOTAL) AS TOTAL, PRODUTO.ESTOQUE AS ESTOQUE
FROM VENDA JOIN PRODUTO ON PRODUTO.COD_INT = VENDA.ID_PROD 
WHERE VENDA.ID_USUARIO=@ID_USUARIO
AND VENDA.BAIXADO =0 AND VENDA.NUM_CAIXA=@NUM_CAIXA
GROUP BY VENDA.COD_BARRA,DESCRICAO_PRODUTO, SETOR, VENDA.UNID, VENDA.PRECO, PRODUTO.ESTOQUE
ORDER BY DESCRICAO_PRODUTO asc

END;



ALTER PROCEDURE [dbo].[uspVendaPesquisar]
	@NUM_CAIXA INT,
	@BAIXADO BIT
AS 
BEGIN 
	SELECT * FROM VENDA WHERE NUM_CAIXA=@NUM_CAIXA AND BAIXADO=@BAIXADO;
END
GO

CREATE PROCEDURE [dbo].[uspVendasPesquisar]
	@NUM_CAIXA INT,
	@ID_USUARIO INT
AS 

BEGIN

SELECT VENDA.COD_BARRA as COD, DESCRICAO_PRODUTO AS DESCRICAO, SUM (QUANT)AS QTDE, SUM (TOTAL) AS TOTAL
FROM VENDA JOIN PRODUTO ON PRODUTO.COD_INT = VENDA.ID_PROD 
WHERE VENDA.ID_USUARIO=@ID_USUARIO
AND VENDA.BAIXADO =0 AND VENDA.NUM_CAIXA=@NUM_CAIXA
GROUP BY VENDA.COD_BARRA,DESCRICAO_PRODUTO
ORDER BY DESCRICAO_PRODUTO asc

END;


CREATE PROCEDURE [dbo].[uspVendaPesquisarTotalDetalhes]
	@NUM_CAIXA INT,
	@ID_USUARIO INT,
	@BAIXADO BIT
AS 

BEGIN

SELECT VENDA.COD_BARRA as COD, DESCRICAO_PRODUTO AS DESCRICAO, VENDA.UNID AS UNID, VENDA.PRECO AS PRECO, SUM (QUANT)AS QTDE, SUM (TOTAL) AS TOTAL, PRODUTO.ESTOQUE AS ESTOQUE
FROM VENDA JOIN PRODUTO ON PRODUTO.COD_INT = VENDA.ID_PROD 
WHERE VENDA.ID_USUARIO=@ID_USUARIO
AND VENDA.BAIXADO =0 AND VENDA.NUM_CAIXA=@NUM_CAIXA
GROUP BY VENDA.COD_BARRA,DESCRICAO_PRODUTO, SETOR, VENDA.UNID, VENDA.PRECO, PRODUTO.ESTOQUE
ORDER BY DESCRICAO_PRODUTO asc

END;

CREATE PROCEDURE [dbo].[uspDepartamentoListarNumeros]
	@NUM_DEPAR INT
AS 

BEGIN

SELECT COD_BARRA as CODIGO, DESCRICAO as DESCRICAO, ESTOQUE as ESTOQUE, PRECO AS PRECO, ( preco * estoque) as TOTAL FROM PRODUTO WHERE PRODUTO.NUM_DEPAR=@NUM_DEPAR ORDER BY PRODUTO.DESCRICAO ASC

END;

CREATE PROCEDURE [dbo].[uspDepartamentoListarNumerototal]
	@NUM_DEPAR INT
AS 

BEGIN

SELECT SUM(PRECO * ESTOQUE) AS TOTAL FROM PRODUTO where PRODUTO.NUM_DEPAR = @NUM_DEPAR

END;

ALTER PROCEDURE [dbo].[uspCancelarItens]
	@ID INT
AS 
BEGIN 

	DELETE FROM VENDA WHERE ID=@ID;

	SELECT @ID AS RETORNO;
END
GO

CREATE PROCEDURE [dbo].[PesquisarClienteId]
	@CLIENTE_ID INT
AS 
BEGIN 
	SELECT * FROM CLIENTE WHERE CLIENTE.CLIENTE_ID=@CLIENTE_ID
END

CREATE PROCEDURE [dbo].[uspVendaAlterarVendaFiscal]
	@NUM_CAIXA INT,
	@NUM_VENDA INT,
	@TAG BIT
AS 
BEGIN 
	UPDATE VENDA SET TAG=@TAG WHERE NUM_CAIXA=@NUM_CAIXA AND NUM_VENDA=@NUM_VENDA

	SELECT @NUM_VENDA AS RETORNO;
END;


OK
CREATE PROCEDURE uspVendasPesquisarRZ
	@NUM_CAIXA INT

AS 

BEGIN

SELECT VENDA.COD_BARRA as COD, DESCRICAO_PRODUTO AS DESCRICAO, SUM (QUANT)AS QTDE, SUM (TOTAL) AS TOTAL
FROM VENDA JOIN PRODUTO ON PRODUTO.COD_INT = VENDA.ID_PROD 
WHERE VENDA.BAIXADO=0 AND VENDA.NUM_CAIXA=1 AND VENDA.TAG=1
GROUP BY VENDA.COD_BARRA,DESCRICAO_PRODUTO
ORDER BY DESCRICAO_PRODUTO asc

END;


OK
CREATE PROCEDURE uspVendaPesquisarDepartamentoRZ
	@NUM_CAIXA INT
AS 
BEGIN 
	SELECT NUM_DEPAR AS DEP, DEPARTAM AS DEPARTAMENTO, SUM(total) AS TOTAL FROM VENDA  
	 INNER JOIN PRODUTO ON PRODUTO.COD_INT = VENDA.ID_PROD WHERE VENDA.BAIXADO = 0 
	 AND VENDA.NUM_CAIXA=1 AND VENDA.TAG=1
	 GROUP BY NUM_DEPAR, DEPARTAM 
	 ORDER BY PRODUTO.NUM_DEPAR ASC;
END;



OK
CREATE PROCEDURE uspVendasSetorRZ
	@NUM_CAIXA INT
AS 
BEGIN 
	SELECT S.ID AS COD, S.DESCRICAO, SUM (TOTAL) AS TOTAL FROM VENDA V LEFT JOIN PRODUTO P ON V.ID_PROD = P.COD_INT
	LEFT JOIN SETOR S ON P.SETOR=S.ID
	 WHERE V.NUM_CAIXA=@NUM_CAIXA AND BAIXADO=0 AND TAG=1
	 GROUP BY S.ID, S.DESCRICAO

END;

GO

CREATE PROCEDURE uspSetorAll
AS BEGIN 
	SELECT * FROM SETOR ORDER BY SETOR.DESCRICAO
END


UPDATE PRODUTO SET SETOR=1 WHERE NUM_DEPAR=1
UPDATE PRODUTO SET SETOR=2 WHERE NUM_DEPAR=6
UPDATE PRODUTO SET SETOR=2 WHERE SETOR=0

ADD TAG PAGAMENTO_VENDA

OK
ALTER PROCEDURE [dbo].[uspPagamentoVendaCadastrar]
	@ID_CLIENTE INT,
	@ID_USUARIO INT,
	@TIPO_PAGAMENTO INT,
	@VALOR DECIMAL(18,2),
	@CNPJ NCHAR(30),
	@NUM_CUPOM INT,
	@BAIXADO BIT,
	@DT DATE,
	@TROCO DECIMAL(18,2),
	@NUM_CAIXA INT,
	@FECHADO BIT,
	@TAG BIT
AS 
BEGIN 
	INSERT INTO PAGAMENTO_VENDA(ID_CLIENTE, ID_USUARIO, TIPO_PAGAMENTO, VALOR, CNPJ, NUM_CUPOM, BAIXADO, DT, TROCO, NUM_CAIXA, FECHADO, TAG)
	VALUES(@ID_CLIENTE, @ID_USUARIO, @TIPO_PAGAMENTO, @VALOR, @CNPJ, @NUM_CUPOM, @BAIXADO, @DT, @TROCO, @NUM_CAIXA, @FECHADO, @TAG)
	SELECT @@IDENTITY AS RETORNO
END


OK
CREATE PROCEDURE uspPagamentoVendaListarRZ
	@NUM_CAIXA INT
AS 
BEGIN 
SELECT TP.TIPO_PAGTO_ID, TP.TIPO_PAGTO, SUM(PV.VALOR - PV.TROCO) AS VALOR FROM TIPO_PAGTO TP 
JOIN PAGAMENTO_VENDA PV ON TP.TIPO_PAGTO_ID=PV.TIPO_PAGAMENTO WHERE PV.NUM_CAIXA=@NUM_CAIXA AND TAG=1 and pv.BAIXADO=0
 GROUP BY TP.TIPO_PAGTO_ID, TP.TIPO_PAGTO ORDER BY TP.TIPO_PAGTO_ID ASC
END
GO


OK
CREATE PROCEDURE uspVendasTributoRZ
	@NUM_CAIXA INT,
	@DATA NCHAR(20)
AS 
BEGIN
SELECT  ALIQUOTA AS TRIB, SUM(TOTAL) TOTAL FROM VENDA
WHERE DATA >=@DATA AND TAG=1 AND VENDA.FECH=0
GROUP BY ALIQUOTA
ORDER BY ALIQUOTA
END;



OK
ALTER PROCEDURE [dbo].[uspVendaAlterarVendaFiscal]
	@NUM_CAIXA INT,
	@NUM_VENDA INT,
	@TAG BIT
AS 
BEGIN 
	UPDATE VENDA SET TAG=@TAG WHERE NUM_CAIXA=@NUM_CAIXA AND NUM_VENDA=@NUM_VENDA

	UPDATE PAGAMENTO_VENDA SET TAG=@TAG WHERE PAGAMENTO_VENDA.NUM_CUPOM=@NUM_VENDA

	SELECT @NUM_VENDA AS RETORNO;
END;


///////////////////////////////////////////////////

ALTER PROCEDURE [dbo].[uspVendasPesquisarRZ]
	@NUM_CAIXA INT

AS 

BEGIN

SELECT VENDA.COD_BARRA as COD, DESCRICAO_PRODUTO AS DESCRICAO, SUM (QUANT)AS QTDE, SUM (TOTAL) AS TOTAL
FROM VENDA JOIN PRODUTO ON PRODUTO.COD_INT = VENDA.ID_PROD 
WHERE VENDA.BAIXADO = 0 AND VENDA.NUM_CAIXA=@NUM_CAIXA AND TAG=1
GROUP BY VENDA.COD_BARRA,DESCRICAO_PRODUTO
ORDER BY DESCRICAO_PRODUTO asc

END;

CREATE PROCEDURE uspVendaDeletarItem
	@ID INT
AS 
BEGIN 
	DELETE FROM VENDA WHERE ID=@ID;
	SELECT @ID RETORNO;
END;


ALTER PROCEDURE [dbo].[uspVendasTributoRZ]
	@NUM_CAIXA INT,
	@DATA NCHAR(20)
AS 
BEGIN
SELECT  ALIQUOTA AS TRIB, SUM(TOTAL) TOTAL FROM VENDA
WHERE DATA >=@DATA AND TAG=1 AND VENDA.BAIXADO=0
GROUP BY ALIQUOTA
ORDER BY ALIQUOTA
END;

ALTER PROCEDURE [dbo].[uspPagamentoVendaListarRZ]
	@NUM_CAIXA INT
AS 
BEGIN 
SELECT TP.TIPO_PAGTO_ID, TP.TIPO_PAGTO, SUM(PV.VALOR - PV.TROCO) AS VALOR FROM TIPO_PAGTO TP 
JOIN PAGAMENTO_VENDA PV ON TP.TIPO_PAGTO_ID=PV.TIPO_PAGAMENTO WHERE PV.NUM_CAIXA=@NUM_CAIXA
AND PV.BAIXADO=0 AND PV.TAG=1 GROUP BY TP.TIPO_PAGTO_ID, TP.TIPO_PAGTO ORDER BY TP.TIPO_PAGTO_ID ASC
END

GO


////////////////////////////////

CREATE PROCEDURE [dbo].[uspUsuarioFecharLogin]
	@LOGADO BIT,
	@NUM_CAIXA INT
AS 
BEGIN 

	UPDATE USUARIO SET LOGADO=@LOGADO WHERE NUM_CAIXA=@NUM_CAIXA

	SELECT @NUM_CAIXA AS RETORNO;
END;


CREATE PROCEDURE uspParametroAlterarServicos
	@CUPOM_IMAGEM BIT,
	@HOMOLOGACAO_TESTE BIT,
	@PLACA BIT,
	@ID_PARAMETRO INT,
	@VENDA_XML BIT,
	@PAGTO_VENDA_XML BIT,
	@TIME_TELA_DESC INT
AS 
BEGIN 
	UPDATE PARAMETRO SET CUPOM_IMAGEM=@CUPOM_IMAGEM, HOMOLOGACAO_TESTE=@HOMOLOGACAO_TESTE, PLACA=@PLACA,
	VENDA_XML=@VENDA_XML, PAGTO_VENDA_XML=@PAGTO_VENDA_XML, TIME_TELA_DESC=@TIME_TELA_DESC
	WHERE ID_PARAMETRO=@ID_PARAMETRO

	SELECT @ID_PARAMETRO AS RETONRO;
END;


ALTER PROCEDURE [dbo].[uspUsuarioAlterarStatusFechado]
	@NUM_CAIXA INT,
	@ID_USUARIO INT,
	@STATUS BIT
AS 

BEGIN

	UPDATE USUARIO SET STATUS=@STATUS WHERE ID_USUARIO=@ID_USUARIO AND NUM_CAIXA=@NUM_CAIXA;

	SELECT @ID_USUARIO AS RETORNO;

END;

CREATE PROCEDURE [dbo].[uspSangriaContadorLinha]
	@ID_USUARIO INT,
	@TIPO INT,
	@NUM_CAIXA INT,
	@FECHADO BIT
AS 
BEGIN 
	SELECT * FROM SANGRIA S WHERE S.ID_USUARIO=@ID_USUARIO AND S.TIPO=@TIPO AND S.NUM_CAIXA=@NUM_CAIXA AND S.FECHADO=@FECHADO;
END;

CREATE PROCEDURE [dbo].[uspSangriaCadastrar]
	@ID_USUARIO INT,
	@VALOR DECIMAL(12,2),
	@DATA DATETIME,
	@DESCRICAO VARCHAR(100),
	@TIPO INT,
	@NUM_CAIXA INT,
	@FECHADO BIT
AS 
BEGIN 
	INSERT INTO SANGRIA(ID_USUARIO, VALOR, DATA, DESCRICAO,TIPO, NUM_CAIXA, FECHADO)VALUES(@ID_USUARIO, @VALOR, @DATA, @DESCRICAO, @TIPO, @NUM_CAIXA, @FECHADO);

	SELECT @@IDENTITY AS RETORNO;
END;

//////////////ADM
CREATE PROCEDURE uspDepartamentoDeletar
	@ID INT
AS 
BEGIN 
	UPDATE DEPARTAMENTO SET STATUS=0 WHERE ID=@ID

	SELECT @ID AS RETORNO;
END;


CREATE PROCEDURE uspDepartamentoListarDescricao
	@DESCRICAO VARCHAR(100)
AS 
BEGIN 
	SELECT * FROM DEPARTAMENTO D WHERE D.DESCRICAO LIKE '%'+ @DESCRICAO +'%' AND D.STATUS=1 ORDER BY D.DESCRICAO ASC;
END;



CREATE PROCEDURE uspProdutoPesquisarCodigoBarrasDescricao
	@DESCRICAO VARCHAR(30)
AS 
BEGIN 
	SELECT * FROM PRODUTO D WHERE D.DESCRICAO LIKE '%' + @DESCRICAO + '%' ORDER BY D.DESCRICAO ASC
END



CREATE PROCEDURE uspProdutoPesquisarCodigoBarrasDescricao1
	@DESCRICAO VARCHAR(30)
AS 
BEGIN 
	SELECT * FROM PRODUTO D WHERE D.COD_BARRA LIKE '%' + @DESCRICAO + '%' ORDER BY D.DESCRICAO ASC
END
GO


